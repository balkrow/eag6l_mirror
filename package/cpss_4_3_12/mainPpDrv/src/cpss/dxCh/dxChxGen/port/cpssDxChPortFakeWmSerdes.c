/*******************************************************************************
*              (c), Copyright 2001, Marvell International Ltd.                 *
* THIS CODE CONTAINS CONFIDENTIAL INFORMATION OF MARVELL SEMICONDUCTOR, INC.   *
* NO RIGHTS ARE GRANTED HEREIN UNDER ANY PATENT, MASK WORK RIGHT OR COPYRIGHT  *
* OF MARVELL OR ANY THIRD PARTY. MARVELL RESERVES THE RIGHT AT ITS SOLE        *
* DISCRETION TO REQUEST THAT THIS CODE BE IMMEDIATELY RETURNED TO MARVELL.     *
* THIS CODE IS PROVIDED "AS IS". MARVELL MAKES NO WARRANTIES, EXPRESSED,       *
* IMPLIED OR OTHERWISE, REGARDING ITS ACCURACY, COMPLETENESS OR PERFORMANCE.   *
********************************************************************************
*/
/**
********************************************************************************
* @file cpssDxChPortFakeWmSerdes.c
*
* @brief CPSS implementation for fake SERDES in WM/ASIM.
*
* @version   1
********************************************************************************
*/

/* macro needed to support the call to PRV_CPSS_PHYSICAL_GLOBAL_PORT_TO_PORT_GROUP_ID_CONVERT_MAC */
/* this define must come before include files */
#define PRV_CPSS_PHYSICAL_GLOBAL_PORT_TO_PORT_GROUP_ID_SUPPORTED_FLAG_CNS
#define CPSS_LOG_IN_MODULE_ENABLE
#include <cpss/dxCh/dxChxGen/port/private/prvCpssDxChPortLog.h>
#include <cpss/dxCh/dxChxGen/config/private/prvCpssDxChInfo.h>
#include <cpss/dxCh/dxChxGen/port/private/prvCpssDxChPortCtrl.h>
#include <cpss/dxCh/dxChxGen/port/cpssDxChPortCtrl.h>
#include <cpss/dxCh/dxChxGen/port/cpssDxChPortCombo.h>
#include <cpss/dxCh/dxChxGen/cpssHwInit/private/prvCpssDxChHwInit.h>

#include <cpss/common/labServices/port/gop/common/siliconIf/mvSiliconIf.h>
#include <cpss/common/labServices/port/gop/port/mvHwsPortMiscIf.h>
#include <cpss/common/labServices/port/gop/port/mvPortModeElements.h>
#include <cpss/common/private/globalShared/prvCpssGlobalDb.h>
#include <cpss/common/private/globalShared/prvCpssGlobalDbInterface.h>

#define EYE_STRING_ARR_SIZE_CNS  124 + 1
typedef struct{
    char*   stringPtr[EYE_STRING_ARR_SIZE_CNS];
}EYE_STRING_ARR_STC;
/* fake function for WM/ASIM/Simics
    values take from Harrier (106) board when running on 10G KR port:
    Console(config-if)# do cpss-api call cpssDxChPortSerdesEomMatrixGet devNum 0 portNum 8 laneNum 0 printEnable true eomInParams MV_HWS_COMPHY_C56G_EOM_IN_PARAMS
    eomInParams.comphyC56GEomInParams.minSamples()>MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_5_E
    eomInParams.comphyC56GEomInParams.berThreshold()>MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_3_E
    eomInParams.comphyC56GEomInParams.eomStatsMode()>false
    eomInParams.comphyC56GEomInParams.berThresholdMax()>MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_3_E
*/
/* single 'BIG' eye */
static const GT_U16 _10G_KR_width      [MAX_EYE_NUM]={ 0, 221, 0 };
static const GT_U16 _10G_KR_height[MAX_EYE_NUM]     ={ 0,  85, 0 };
static const EYE_STRING_ARR_STC   _10G_KR_eyeStringArr = {{
"..............................................................................................................#.#|................................................................................................................",
".............................................................................................#################.##|#####################...........................................................................................",
".................................................................................#.##########.#..................|...................#.######.....................................................................................",
".........................................................................##.#####.#..............................|...........................#######..............................................................................",
"....................................................................#####..#.#...................................|..................................####..........................................................................",
"..............................................................######.............................................|......................................##........................................................................",
"...........................................................###...................................................|........................................##......................................................................",
".........................................................##......................................................|..........................................####..................................................................",
"....................................................#.###........................................................|..............................................##.#..............................................................",
".....................................................#...........................................................|................................................#.#.............................................................",
".................................................###.............................................................|...................................................##...........................................................",
"..............................................###................................................................|.....................................................###........................................................",
".............................................#...................................................................|........................................................##......................................................",
"...........................................##....................................................................|..........................................................##....................................................",
".........................................##......................................................................|............................................................##..................................................",
"......................................###........................................................................|..............................................................###...............................................",
".....................................#...........................................................................|.................................................................##.............................................",
"....................................#............................................................................|...................................................................##...........................................",
"..................................##.............................................................................|.....................................................................#..........................................",
".................................#.#.............................................................................|......................................................................##........................................",
"...............................##................................................................................|........................................................................##......................................",
".............................#...................................................................................|..........................................................................#.....................................",
"............................#.#..................................................................................|..........................................................................####..................................",
"..........................##.....................................................................................|..............................................................................#.................................",
".........................#.......................................................................................|...............................................................................#................................",
"........................#........................................................................................|................................................................................###.............................",
".......................#.........................................................................................|...................................................................................#............................",
"......................#..........................................................................................|....................................................................................##..........................",
".....................#...........................................................................................|......................................................................................##........................",
"....................#.#..........................................................................................|........................................................................................#.......................",
".................................................................................................................|.........................................................................................##.....................",
"..................##.............................................................................................|..........................................................................................#.....................",
".................#...............................................................................................|...........................................................................................###..................",
".................................................................................................................|..............................................................................................#.................",
"...............##................................................................................................|..............................................................................................##................",
"..............#.#................................................................................................|................................................................................................##..............",
".............#...................................................................................................|..................................................................................................##............",
"...........#.....................................................................................................|....................................................................................................#...........",
".........##.#....................................................................................................|.....................................................................................................#..........",
".......##........................................................................................................|......................................................................................................##........",
"......##.........................................................................................................|.........................................................................................................#......",
"....##...........................................................................................................|........................................................................................................#.##....",
".###.............................................................................................................|............................................................................................................###.",
"----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------",
".###.#...........................................................................................................|..........................................................................................................#####.",
"....###..........................................................................................................|........................................................................................................####....",
"......#..........................................................................................................|.........................................................................................................#......",
".......###.......................................................................................................|......................................................................................................##........",
".........###.....................................................................................................|....................................................................................................##..........",
"...........##....................................................................................................|...................................................................................................##...........",
".............#.#.................................................................................................|..................................................................................................##............",
"..............##.#...............................................................................................|...............................................................................................###..............",
"...............##................................................................................................|...............................................................................................#................",
"..................#..............................................................................................|..............................................................................................#.................",
".................##..............................................................................................|...........................................................................................###..................",
"..................##.............................................................................................|................................................................................................................",
".................................................................................................................|........................................................................................###.....................",
"....................##...........................................................................................|.......................................................................................##.......................",
".....................#.#.........................................................................................|....................................................................................#.##........................",
"......................##.........................................................................................|.....................................................................................#..........................",
".......................#.........................................................................................|..................................................................................##............................",
"........................#........................................................................................|................................................................................###.............................",
".........................#.#.....................................................................................|...............................................................................#................................",
"..........................##.....................................................................................|.............................................................................##.................................",
"............................##.#.................................................................................|...........................................................................###..................................",
".............................###.................................................................................|.........................................................................##.....................................",
"...............................##................................................................................|........................................................................##......................................",
".................................#...............................................................................|......................................................................##........................................",
"..................................##.............................................................................|...................................................................###..........................................",
"....................................#............................................................................|.................................................................####...........................................",
".....................................###.........................................................................|.................................................................##.............................................",
"......................................###........................................................................|.............................................................####...............................................",
".........................................###.....................................................................|...........................................................###..................................................",
"...........................................####..................................................................|..........................................................##....................................................",
".............................................##..................................................................|......................................................####......................................................",
"..............................................####...............................................................|....................................................####........................................................",
".................................................######..........................................................|...................................................##...........................................................",
"....................................................###..........................................................|...............................................####.............................................................",
"....................................................#.###........................................................|............................................####.#..............................................................",
".........................................................####....................................................|.........................................#####..................................................................",
"...........................................................######..#.............................................|......................................####......................................................................",
"..............................................................#########..........................................|...................................#####........................................................................",
"....................................................................#########.#..#...............................|.............................#########..........................................................................",
".........................................................................##.########...#.........................|.......................###########..............................................................................",
".................................................................................#.###########..##...............|.................##.#######.....................................................................................",
".............................................................................................###################.|#####################...........................................................................................",
"..............................................................................................................#.#|................................................................................................................",
NULL
}};

static const GT_U16 use_single_eye_width      [MAX_EYE_NUM]={ 0,  97, 0 };
static const GT_U16 use_single_eye_height[MAX_EYE_NUM]      ={ 0,  43, 0 };
static const EYE_STRING_ARR_STC   use_single_eye_eyeStringArr = {{
"..............................................#####|...............................................",
"...........................................######..|###............................................",
"........................................#####......|.#.###.........................................",
".....................................#####.........|...##.##.......................................",
"...................................####............|........####...................................",
"................................####...............|.........#.####................................",
"..............................###..................|............####...............................",
".............................##....................|..............#.###............................",
"...........................##......................|...............#.###...........................",
"........................###........................|...................####........................",
"......................####.........................|.....................#####.....................",
".....................##............................|.......................#####...................",
"....................#..#...........................|.....................#.#.####..................",
".................#.##..............................|..........................###..................",
"................###................................|............................#####..............",
"..............##...................................|.............................######............",
"............###....................................|...............................######..........",
"...........#.#.....................................|..................................#####........",
".........##........................................|....................................#####......",
"........##.........................................|......................................####.#...",
"......##...........................................|........................................#####..",
"....###............................................|.........................................######",
".####..............................................|............................................###",
"---------------------------------------------------------------------------------------------------",
".#####.............................................|............................................###",
"....#####..........................................|.........................................######",
"......#####........................................|......................................#.###.#..",
"........####.......................................|....................................####.#.#...",
".........#####.....................................|..................................#.#####......",
"...........####....................................|..................................#####........",
"............#####..................................|................................#####..........",
"..............####.................................|.............................######............",
"................####...............................|...........................######..............",
".................#.####............................|.........................###...................",
"....................####...........................|........................#####..................",
".....................####..........................|.......................##.##...................",
"......................#####........................|....................######.....................",
"........................######.#...................|...................####........................",
"...........................####....................|................####...........................",
".............................#####.................|..............#####............................",
"..............................######.#.............|...........#####...............................",
"................................######.............|........#######................................",
"...................................#####...........|......######...................................",
".....................................######........|....####.......................................",
"........................................########...|######.........................................",
"...........................................########|###............................................",
NULL
}};

static const GT_U16 use_3_eyes_width      [MAX_EYE_NUM]={ 15, 24, 15 };
static const GT_U16 use_3_eyes_height[MAX_EYE_NUM]     ={ 38, 44, 34 };
static const EYE_STRING_ARR_STC   use_3_eyes_eyeStringArr = {{
"#............#|.#..########.......",
"..............|.#......#######....",
"..........##..|###........######..",
"............#.|####..........#####",
"..............|.###...........####",
"........#.....|.###...............",
"..............|#######.#..........",
".......#......|..########.........",
"..............|..########.........",
".........#....|...#######.........",
"......#.......|...########........",
".....#........|...#########.......",
"....#.........|...#########.......",
"..............|...#########.#.....",
"..##..........|....########.##....",
"..............|.....##########....",
"..............|.....##########....",
"..............|......###########..",
".#............|.....#############.",
"----------------------------------",
".#######......|.................#.",
"..######......|...............##..",
"..######......|...................",
"..######......|............#......",
"..#######.....|..............#....",
"....######....|.............#.....",
"....####.#....|...................",
".....######...|...........#.......",
"......####....|..........#........",
".......####...|...................",
".......##.#...|...................",
".......##.#...|.......#.#.........",
"........#.#...|....###.#..........",
"........#.###.|...................",
"..........##..|...................",
"..........###.|...#.............##",
"#.........##.#|#.#............##..",
"###...........|............###....",
"#####........#|.........###.......",
"#########.....|.#.....##..........",
"........##.|###.########..        ",
"........##.|..#.....######        ",
".......##..|#.###......###        ",
".......##.#|...###........        ",
".......#...|.....#........        ",
".....#.....|..##.##.......        ",
".....#.#...|......#.#.....        ",
"....###....|......####....        ",
"....###....|.....#####....        ",
"....##.....|......####....        ",
"...##......|.....##.###...        ",
"..#.###....|........####..        ",
".####......|.........###..        ",
"..#........|.......#.###.#        ",
"#.###......|.......#.###.#        ",
".##........|.........#####        ",
".##.#......|..........####        ",
".##........|..........####        ",
".#.........|..........####        ",
"--------------------------        ",
"#..........|............#.        ",
"#..........|..............        ",
"#..........|..........##..        ",
"##.........|.........#..#.        ",
"##.........|..............        ",
".#.........|.............#        ",
".###.......|..............        ",
"..##.......|...........#..        ",
"...#.......|.......##.#...        ",
"...........|..............        ",
"...........|..............        ",
"....#.#....|.......#.#....        ",
".....#.....|........#.....        ",
".....#.....|......#.......        ",
"...........|..............        ",
"...........|.....#........        ",
".......#...|...##.........        ",
"...........|............##        ",
"##......#..|.#.......###..        ",
"######.....|.#.....##.....        ",
"##########.|.######.......        ",
"...########|.##...........        ",
"......#####|..............        ",
"...........|#.............        ",
"..######..###|#######.........    ",
"####.......##|.########.......    ",
"..........##.|..##########....    ",
"..........##.|..#.#...#######.    ",
".........####|...........#####    ",
".........###.|.....#........##    ",
".........####|......#........#    ",
".......####.#|.......##.......    ",
".......####..|.........#......    ",
"......#####..|................    ",
"......#####..|................    ",
"......#####..|................    ",
".....###.#...|..........#.....    ",
"....#.###....|...........##...    ",
"...#######...|...........#....    ",
"..######.....|.............#..    ",
".########....|.............##.    ",
"..#####......|................    ",
"..#####......|................    ",
".######......|...............#    ",
"#######......|...............#    ",
"------------------------------    ",
"#............|.......########.    ",
".#...........|.......#########    ",
".#...........|.......########.    ",
".#...........|......#########.    ",
".#...........|.....##########.    ",
"..#.#........|.....#########..    ",
"...###.......|.....########...    ",
"....##.......|.....########...    ",
".....#.......|....#######.....    ",
".............|...#.#####......    ",
"......#......|...#######......    ",
"......##.....|...#######......    ",
".......#.....|....######......    ",
".......##....|.#.######.......    ",
".........##..|..#####.........    ",
".............|..####..........    ",
".........#..#|..###..........#    ",
"##.........#.|#.###.......###.    ",
NULL
}};

typedef enum{
    SINGLE_BIG_EYE,
    SINGLE_EYE,
    _3_EYES,
}EYE_TYPE;

/* fix for JIRA : CPSS-14649 : Aldrin3-M Serdes EOM return GT_OK in SIMICs */
GT_STATUS prvCpssDxChPortFakeSerdesEomMatrixGet
(
    IN   GT_U8                              devNum,
    IN   GT_PHYSICAL_PORT_NUM               portNum,
    IN   GT_U32                             laneNum,
    IN   GT_U32                             numActiveLanes,
    IN   GT_BOOL                            printEnable,
    IN   MV_HWS_SERDES_EOM_IN_PARAMS_UNT    *eomInParams,
    OUT  MV_HWS_SERDES_EOM_OUT_PARAMS_UNT   *eomOutParams
)
{
    GT_STATUS   rc;
    GT_U32  ii;
    MV_HWS_PORT_STANDARD portMode;
    GT_U32  portMacNum;
    GT_BOOL linkUp;
    GT_U32  speed_in_megabits;
    EYE_TYPE eyeType;
    const GT_U16 *widthPtr = NULL;
    const GT_U16 *heightPtr = NULL;
    const EYE_STRING_ARR_STC   *eyeStringArr = NULL;

    if(PRV_CPSS_PP_MAC(devNum)->devFamily != CPSS_PP_FAMILY_DXCH_HARRIER_E)
    {
        CPSS_LOG_ERROR_AND_RETURN_MAC(GT_NOT_IMPLEMENTED, "Implemented only for 56G serdeses (Harrier)");
    }

    if(laneNum >= numActiveLanes)
    {
        CPSS_LOG_ERROR_AND_RETURN_MAC(GT_BAD_PARAM, LOG_ERROR_NO_MSG);
    }

    switch(eomInParams->comphyC56GEomInParams.minSamples)
    {
        case MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_5_E:
        case MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_6_E:
        case MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_7_E:
        case MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_8_E:
        case MV_HWS_PORT_SERDES_MIN_SAMPLES_ORDER_10_9_E:
            break;
        default:
            CPSS_LOG_ERROR_AND_RETURN_ON_ENUM_MAC(eomInParams->comphyC56GEomInParams.minSamples);
    }
    switch(eomInParams->comphyC56GEomInParams.berThreshold)
    {
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_3_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_4_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_5_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_6_E:
            break;
        default:
            CPSS_LOG_ERROR_AND_RETURN_ON_ENUM_MAC(eomInParams->comphyC56GEomInParams.berThreshold);
    }

    switch(eomInParams->comphyC56GEomInParams.berThresholdMax)
    {
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_3_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_4_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_5_E:
        case MV_HWS_PORT_SERDES_BER_THRESHOLD_ORDER_10_6_E:
            break;
        default:
            CPSS_LOG_ERROR_AND_RETURN_ON_ENUM_MAC(eomInParams->comphyC56GEomInParams.berThresholdMax);
    }

    rc = cpssDxChPortLinkStatusGet(devNum,portNum,&linkUp);
    if(rc != GT_OK)
    {
        return rc;
    }

    if(linkUp == GT_FALSE)
    {
        CPSS_LOG_ERROR_AND_RETURN_MAC(GT_FAIL, "The WM/Asim link down , so not get 'eye' info");
    }

    PRV_CPSS_DXCH_MAC_IN_PHY_PORT_NUM_CHECK_AND_MAC_NUM_GET_MAC(devNum, portNum, portMacNum);

    rc = prvCpssCommonPortIfModeToHwsTranslate(devNum,
                                PRV_CPSS_DXCH_PORT_IFMODE_MAC(devNum, portMacNum),
                                PRV_CPSS_DXCH_PORT_SPEED_MAC(devNum, portMacNum),
                                &portMode);
    if(rc != GT_OK)
    {
        CPSS_LOG_ERROR_AND_RETURN_MAC(rc, "prvCpssCommonPortIfModeToHwsTranslate failed");
    }

    speed_in_megabits = prvCpssCommonPortSpeedEnumToMbPerSecConvert(PRV_CPSS_DXCH_PORT_SPEED_MAC(devNum, portMacNum));

    if(speed_in_megabits < 25000 && numActiveLanes == 1)
    {
        /* 10G KR */
        eyeType = SINGLE_BIG_EYE;
    }
    else
    if(speed_in_megabits < 50000 && numActiveLanes == 4)
    {
        /* 40G KR4 */
        eyeType = SINGLE_BIG_EYE;
    }
    else
    {
        if(HWS_PAM4_MODE_CHECK(portMode))
        {
            eyeType = _3_EYES;
        }
        else
        {
            eyeType = SINGLE_EYE;
        }
    }

    if(eyeType == _3_EYES)
    {
        /* 3 eyes */
        widthPtr        =  &use_3_eyes_width       [0];
        heightPtr       =  &use_3_eyes_height [0];
        eyeStringArr    =  &use_3_eyes_eyeStringArr;
    }
    else
    if(eyeType == SINGLE_EYE)
    {
        /* single eye */
        widthPtr        =  &use_single_eye_width       [0];
        heightPtr       =  &use_single_eye_height [0];
        eyeStringArr    =  &use_single_eye_eyeStringArr;
    }
    else
    {
        /* single 'BIG' eye */
        widthPtr        =  &_10G_KR_width       [0];
        heightPtr       =  &_10G_KR_height [0];
        eyeStringArr    =  &_10G_KR_eyeStringArr;
    }

    if(printEnable == GT_TRUE)
    {
        for(ii = 0 ; ii < EYE_STRING_ARR_SIZE_CNS; ii++)
        {
            if(eyeStringArr->stringPtr[ii] == NULL)
            {
                break;
            }

            cpssOsPrintf(eyeStringArr->stringPtr[ii]);
            cpssOsPrintf("\n");
        }
    }

    /* memset to 0 on eomOutParams already done in internal_cpssDxChPortSerdesEomMatrixGet() */

    for(ii = 0 ; ii < MAX_EYE_NUM; ii++)
    {
        eomOutParams->comphyC56GEomOutParams.width_mUI      [ii] = widthPtr      [ii];
        eomOutParams->comphyC56GEomOutParams.height_mV[ii]      = heightPtr     [ii];
    }

    return GT_OK;
}



